<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disposable SMTP Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mail-list::-webkit-scrollbar { width: 8px; }
        .mail-list::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .mail-list::-webkit-scrollbar-track { background-color: #f1f5f9; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">

    <!-- Global Message Box -->
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <!-- Messages appear here -->
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="max-w-6xl mx-auto shadow-xl rounded-2xl bg-white flex h-[90vh] overflow-hidden">
        
        <!-- Mail Application View (no auth now) -->
        <div id="view-mail-app" class="w-full flex">

            <!-- Sidebar Navigation -->
            <div class="w-1/4 bg-gray-800 p-6 flex flex-col justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-yellow-400 mb-4">TempMail</h1>
                    <p class="text-sm text-gray-400 mb-1">Your Temporary Email:</p>
                    <div class="bg-gray-700 text-white p-2 rounded-lg text-sm font-mono truncate mb-3" id="current-user-display">
                        <!-- Disposable email populated here -->
                    </div>
                    <button onclick="generateNewMailbox()" class="w-full mb-6 px-4 py-2 bg-blue-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-blue-400 transition">
                        Generate New Address
                    </button>

                    <button onclick="setView('compose')" 
                            class="w-full mb-4 px-4 py-3 bg-yellow-500 text-gray-900 font-semibold rounded-lg shadow-md hover:bg-yellow-400 transition">
                        <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>
                        Compose Mail
                    </button>

                    <div class="space-y-2">
                        <button onclick="setView('inbox')" class="w-full text-left p-3 rounded-lg text-white font-medium bg-gray-700 hover:bg-gray-600 transition">
                            <svg class="w-5 h-5 inline-block mr-2 -mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>
                            Inbox (<span id="inbox-count">0</span>)
                        </button>
                        <button onclick="showInfo('Sent Mail tracking is not persisted; this client focuses on disposable inbox functionality.')" class="w-full text-left p-3 rounded-lg text-gray-400 hover:bg-gray-700 transition">
                            <svg class="w-5 h-5 inline-block mr-2 -mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.166 1.486l5-1.111a1 1 0 00.41-.954V9a1 1 0 012 0v6.764a1 1 0 00.41.954l5 1.11a1 1 0 001.166-1.486l-7-14z"></path></svg>
                            Sent Mail
                        </button>
                    </div>
                </div>

                <div class="text-xs text-gray-500 mt-4">
                    <p>C++ SMTP Project Client</p>
                    <p>API Proxy Port: 8000</p>
                    <p class="mt-2 text-[11px] text-gray-400">
                        This is a disposable email service. Anyone who knows your address can read the inbox until the server is reset or files are deleted.
                    </p>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="w-3/4 p-8 overflow-y-auto">
                
                <!-- Compose View -->
                <div id="view-compose" class="view-content" style="display: none;">
                    <h2 class="text-3xl font-semibold text-gray-800 mb-6 border-b pb-2">New Message</h2>
                    <div class="space-y-4">
                        <input type="email" id="mail-to" placeholder="To: recipient@mydomain.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                        <input type="text" id="mail-subject" placeholder="Subject" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                        <textarea id="mail-body" rows="12" placeholder="Write your message here..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 resize-none"></textarea>
                        
                        <button onclick="sendMail()" id="send-btn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-500 transition">
                            <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            Send Mail
                        </button>
                        <span id="send-loading" class="hidden text-gray-500 ml-4">Sending...</span>
                    </div>
                </div>

                <!-- Inbox View -->
                <div id="view-inbox" class="view-content">
                    <h2 class="text-3xl font-semibold text-gray-800 mb-6 border-b pb-2">Inbox</h2>
                    <div id="mail-list" class="mail-list space-y-2 h-[calc(90vh-10rem)] overflow-y-auto pr-2">
                        <div class="text-gray-500 py-12 text-center" id="empty-inbox">Loading mail...</div>
                    </div>
                </div>

                <!-- Read Mail View -->
                <div id="view-read" class="view-content" style="display: none;">
                    <button onclick="setView('inbox')" class="mb-4 text-yellow-600 hover:text-yellow-700 font-medium flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Back to Inbox
                    </button>
                    <div class="bg-gray-100 p-6 rounded-xl shadow-inner">
                        <h2 id="read-subject" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                        <p class="text-sm text-gray-600 mb-1">Date: <span id="read-date" class="font-medium"></span></p>
                        <p class="text-sm text-gray-600 mb-4">From: <span id="read-from" class="font-medium"></span></p>
                        <div id="read-body" class="whitespace-pre-wrap text-gray-700 leading-relaxed border-t border-gray-300 pt-4"></div>
                    </div>
                    
                    <button onclick="setReplyView()" class="mt-6 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-500 transition">
                        <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.707 3.293a1 1 0 010 1.414L5.414 7H15a1 1 0 110 2H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                        Reply
                    </button>
                </div>

                <!-- Reply View -->
                <div id="view-reply" class="view-content" style="display: none;">
                    <h2 class="text-3xl font-semibold text-gray-800 mb-6 border-b pb-2">Reply Message</h2>
                    <div class="space-y-4">
                        <input type="email" id="reply-to" placeholder="To:" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                        <input type="text" id="reply-subject" placeholder="Subject" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                        <textarea id="reply-body" rows="12" placeholder="Write your reply here..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 resize-none"></textarea>
                        
                        <button onclick="sendMail(true)" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-500 transition">
                            <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            Send Reply
                        </button>
                        <button onclick="setView('read')" class="px-4 py-3 text-gray-600 hover:text-gray-800 font-semibold transition">Cancel</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
    const API_BASE_URL = 'http://10.20.29.53:8000/api';

    let mailData = []; 
    let currentMail = null; 
    let currentUserEmail = '';  // disposable mailbox address

    // ----------------- Utility: Toast -----------------
    function showInfo(message, type = 'success') {
        const box = document.getElementById('message-box');
        let bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
        let icon = type === 'error'
            ? 'M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z'
            : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z';

        box.innerHTML = `
            <div class="px-4 py-3 rounded-lg shadow-xl text-white font-medium flex items-center ${bgColor}">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="${icon}" clip-rule="evenodd"></path></svg>
                <span>${message}</span>
            </div>
        `;
        box.classList.remove('opacity-0', 'pointer-events-none');
        box.classList.add('opacity-100');

        setTimeout(() => {
            box.classList.remove('opacity-100');
            box.classList.add('opacity-0', 'pointer-events-none');
        }, 3000);
    }

    // ----------------- URL helpers -----------------
    function getMailboxFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('mailbox'); // may be null
    }

    function setMailboxInURL(email) {
        const params = new URLSearchParams(window.location.search);
        params.set('mailbox', email);
        const newUrl = window.location.pathname + '?' + params.toString();
        // replaceState avoids adding history entries
        window.history.replaceState({}, '', newUrl);
    }

    // ----------------- Disposable mailbox logic -----------------

    async function generateNewMailbox() {
        try {
            const resp = await fetch(`${API_BASE_URL}/new_mailbox`, {
                method: 'POST'
            });
            if (!resp.ok) {
                throw new Error(`HTTP ${resp.status}`);
            }
            const result = await resp.json();
            currentUserEmail = result.email;

            // âœ… persist via URL query param
            setMailboxInURL(currentUserEmail);

            document.getElementById('current-user-display').textContent = currentUserEmail;
            showInfo(`New disposable address: ${currentUserEmail}`);
            setView('inbox');
        } catch (err) {
            console.error('Error generating mailbox:', err);
            showInfo('Failed to generate new mailbox. Is the API running?', 'error');
        }
    }

    // ----------------- View switching -----------------

    function setView(viewId) {
        document.querySelectorAll('.view-content').forEach(el => el.style.display = 'none');
        const targetView = document.getElementById(`view-${viewId}`);
        if (targetView) {
            targetView.style.display = 'block';
            if (viewId === 'inbox') {
                fetchInbox();
            }
        }
    }

    // ----------------- Inbox logic -----------------

    async function fetchInbox() {
        const list = document.getElementById('mail-list');
        if (!currentUserEmail) {
            list.innerHTML = `<div class="text-gray-500 py-12 text-center">No mailbox yet. Click "Generate New Address".</div>`;
            document.getElementById('inbox-count').textContent = 0;
            return;
        }

        list.innerHTML = `<div class="text-gray-500 py-12 text-center" id="loading-inbox">
                            <svg class="animate-spin h-5 w-5 mr-3 inline-block text-yellow-500" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16 8 8 0 01-8-8z"></path>
                            </svg>
                            Loading mail for ${currentUserEmail}...
                          </div>`;
        document.getElementById('inbox-count').textContent = '...';
        
        try {
            const response = await fetch(`${API_BASE_URL}/inbox/${encodeURIComponent(currentUserEmail)}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            mailData = await response.json();
            renderInboxList(mailData);

        } catch (error) {
            console.error("Failed to fetch inbox:", error);
            showInfo(`Error loading inbox: ${error.message}. Check API proxy.`, 'error');
            list.innerHTML = `<div class="text-red-500 py-12 text-center">Failed to load inbox.</div>`;
            document.getElementById('inbox-count').textContent = 0;
        }
    }

    function renderInboxList(mails) {
        const list = document.getElementById('mail-list');
        list.innerHTML = '';
        document.getElementById('inbox-count').textContent = mails.length;

        if (mails.length === 0) {
            list.innerHTML = `<div class="text-gray-500 py-12 text-center">Inbox is empty.</div>`;
            return;
        } 

        mails.forEach(mail => {
            const item = document.createElement('div');
            item.className = 'flex items-center p-3 bg-white hover:bg-gray-100 rounded-lg shadow-sm cursor-pointer border border-gray-200';
            item.onclick = () => readMail(mail.id);
            
            const datePart = mail.date
                ? new Date(mail.date).toLocaleString('en-US', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })
                : 'Unknown Date';

            item.innerHTML = `
                <div class="w-1/3 font-semibold text-gray-800 truncate">${mail.from}</div>
                <div class="w-2/3 flex justify-between items-center ml-4">
                    <span class="truncate text-gray-700">${mail.subject}</span>
                    <span class="text-xs text-gray-500 min-w-max ml-4">${datePart}</span>
                </div>
            `;
            list.appendChild(item);
        });
    }

    // ----------------- Read / Reply -----------------

    function readMail(mailId) {
        currentMail = mailData.find(m => m.id === mailId);
        if (!currentMail) return;

        document.getElementById('read-subject').textContent = currentMail.subject;
        document.getElementById('read-from').textContent = currentMail.from;
        document.getElementById('read-date').textContent = currentMail.date ? new Date(currentMail.date).toLocaleString() : 'N/A';
        document.getElementById('read-body').textContent = currentMail.body;

        setView('read');
    }

    function setReplyView() {
        if (!currentMail) {
            showInfo('Please select a mail to reply to first.', 'error');
            return;
        }
        
        const fromField = currentMail.from;
        const match = fromField.match(/<([^>]+)>/);
        const cleanRecipient = match ? match[1] : fromField;

        document.getElementById('reply-to').value = cleanRecipient;
        
        const originalSubject = currentMail.subject.startsWith('Re: ') ? currentMail.subject : `Re: ${currentMail.subject}`;
        document.getElementById('reply-subject').value = originalSubject;
        
        const quote = `\n\n---\nOriginal message from ${currentMail.from} on ${currentMail.date}:\n${currentMail.body.split('\n').map(line => `> ${line}`).join('\n')}`;
        document.getElementById('reply-body').value = "\n\n" + quote;

        setView('reply');
    }

    // ----------------- Send -----------------

    async function sendMail(isReply = false) {
        const toField = isReply ? 'reply-to' : 'mail-to';
        const subjectField = isReply ? 'reply-subject' : 'mail-subject';
        const bodyField = isReply ? 'reply-body' : 'mail-body';

        const recipient = document.getElementById(toField).value.trim();
        const subject = document.getElementById(subjectField).value.trim();
        const body = document.getElementById(bodyField).value.trim();
        const sender = currentUserEmail;

        if (!currentUserEmail) {
            showInfo('No disposable address yet. Generate one first.', 'error');
            return;
        }

        if (!recipient || !subject || !body) {
            showInfo('All fields must be filled out to send mail.', 'error');
            return;
        }
        
        const btn = document.getElementById('send-btn');
        const loading = document.getElementById('send-loading');
        
        btn.disabled = true;
        loading.classList.remove('hidden');

        const mailPayload = {
            from: sender,
            rcpt_to: recipient,
            subject: subject,
            body: body,
        };

        try {
            const response = await fetch(`${API_BASE_URL}/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(mailPayload)
            });

            const result = await response.json();

            if (response.ok) {
                showInfo(`Mail successfully sent to ${recipient}.`);
                
                if (isReply) {
                    setView('read'); 
                } else {
                    document.getElementById('mail-to').value = '';
                    document.getElementById('mail-subject').value = '';
                    document.getElementById('mail-body').value = '';
                    setView('inbox');
                }
            } else {
                showInfo(`Failed to send mail: ${result.message}`, 'error');
            }
        } catch (error) {
            console.error("API Send Error:", error);
            showInfo(`Connection failed. Is Python Proxy running? Error: ${error.message}`, 'error');
        } finally {
            btn.disabled = false;
            loading.classList.add('hidden');
        }
    }

    // ----------------- Init -----------------

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Try to read mailbox from URL
        const existing = getMailboxFromURL();
        if (existing) {
            currentUserEmail = existing;
            document.getElementById('current-user-display').textContent = currentUserEmail;
            showInfo(`Using address from URL: ${currentUserEmail}`);
            setView('inbox');
        } else {
            // 2. No mailbox in URL: create a new one
            generateNewMailbox();
        }
    });
    </script>


</body>
</html>
